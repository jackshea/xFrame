# é€šç”¨äº‹ä»¶æ€»çº¿

ä¸€ä¸ªç”¨ C# ç¼–å†™çš„ Unity åŒæ­¥äº‹ä»¶æ€»çº¿ï¼Œä½¿ç”¨ä¸¥æ ¼ç±»å‹åŒ–äº‹ä»¶å’Œæ³›å‹æ¥å‡å°‘è¿è¡Œæ—¶å¼€é”€ã€‚

## åŠŸèƒ½

*   äº‹ä»¶è¢«å®šä¹‰ä¸ºç±»å‹ï¼Œè€Œä¸æ˜¯æŸä¸ªç±»çš„æˆå‘˜æˆ–å­—ç¬¦ä¸² IDã€‚
*   ä½¿ç”¨æ³›å‹å°†è¿è¡Œæ—¶å¼€é”€è½¬ç§»åˆ°ç¼–è¯‘æœŸã€‚*ï¼ˆæ²¡æœ‰ `Dictionary<Type, Listeners>`ï¼‰*
*   ç›‘å¬å™¨åœ¨è®¢é˜…äº‹ä»¶æ—¶å¯ä»¥åŒ…å«ä¸€ä¸ª[ä¼˜å…ˆçº§](#priority)æ•°å€¼ï¼Œä»¥æ§åˆ¶äº‹ä»¶æ‰§è¡Œçš„é¡ºåºï¼Œè€Œä¸å—ç›‘å¬å™¨*ä½•æ—¶*è®¢é˜…çš„å½±å“ã€‚
*   å†…ç½®æ”¯æŒå°†[äº‹ä»¶å®šå‘](#targeted-events)åˆ°ç‰¹å®šå¯¹è±¡ï¼Œå¹¶å¯é€‰æä¾›è§¦å‘äº‹ä»¶çš„æºå¯¹è±¡ã€‚
*   äº‹ä»¶æ•°æ®å¯ä»¥è¢«[ç›‘å¬å™¨ä¿®æ”¹](#modifying-event-data) ï¼Œæˆ–è¢«å®Œå…¨[æ¶ˆè´¹](#consuming-events)ä»¥åœæ­¢å®ƒã€‚
*   å½“å…¶ä»–äº‹ä»¶æ­£åœ¨è¢«è§¦å‘æ—¶ï¼Œäº‹ä»¶å¯ä»¥è¢«åŠ å…¥é˜Ÿåˆ—ã€‚

## ç”¨æ³•

è¦åˆ›å»ºäº‹ä»¶æ€»çº¿ï¼Œè¯·ä½¿ç”¨ `GenericEventBus<TBaseEvent>` ç±»å‹ï¼š

```c#
var eventBus = new GenericEventBus<TBaseEvent>();
```

`TBaseEvent` æ˜¯æ‰€æœ‰äº‹ä»¶ç±»å‹å¿…é¡»ç»§æ‰¿æˆ–å®ç°çš„åŸºç±»å‹ã€‚ä½ å¯ä»¥ä½¿ç”¨ `System.Object` ä½œä¸ºåŸºç±»å‹ä»¥å…è®¸ä»»ä½•ç±»å‹ç”¨ä½œäº‹ä»¶ï¼Œä½†æˆ‘å»ºè®®å®šä¹‰ä¸€ä¸ªç©ºæ¥å£ä½œä¸ºåŸºç±»å‹ï¼š

```c#
public interface IEvent {}
```

```c#
var eventBus = new GenericEventBus<IEvent>();
```

å¦åˆ™ï¼Œ *ä»»ä½•*å¯¹è±¡éƒ½å¯ä»¥ä½œä¸ºäº‹ä»¶è§¦å‘ï¼Œè¿™ä¼šå¾ˆå¥‡æ€ªä¸”ä»¤äººå›°æƒ‘ã€‚

* * *

ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ï¼Œæˆ‘å»ºè®®ç”¨ä½ è‡ªå·±çš„ç±»å‹ç»§æ‰¿ `GenericEventBus<TBaseEvent>`ï¼Œå¹¶åœ¨ä»£ç ä¸­ä½¿ç”¨è¯¥ç±»å‹ï¼š

```cs
public class GameEventBus : GenericEventBus<IEvent> {}
```

> ğŸ’¡ å¦‚æœä½ æƒ³å°†äº‹ä»¶æ€»çº¿ä½œä¸ºé™æ€ç±»ä½¿ç”¨ä»¥ä¾¿æ›´è½»æ¾åœ°è®¿é—®ï¼Œå¯ä»¥ä½¿ç”¨[è¿™ä¸ªæ¨¡æ¿](https://gist.github.com/PeturDarri/233cae6571041e8b48d3584fb781f902)åˆ›å»ºä¸€ä¸ªé™æ€å°è£…ã€‚

* * *

è¦å®šä¹‰æ–°äº‹ä»¶ï¼Œåªéœ€å®šä¹‰ä¸€ä¸ªç»§æ‰¿æˆ–å®ç°ä½ çš„äº‹ä»¶åŸºç±»å‹çš„ç±»å‹ï¼š

```c#
public struct GameStartedEvent : IEvent
{
}
```

*äº‹ä»¶æ˜¯å¦å¯ä»¥å®šä¹‰ä¸ºç±»ï¼Ÿ*

äº‹ä»¶å¯ä»¥å®šä¹‰ä¸º `class` æˆ– `struct`ï¼Œä½†æˆ‘å»ºè®®ä½¿ç”¨ structï¼Œä»¥é¿å…åœ¨åˆ›å»ºæ–°å®ä¾‹æ—¶è¿›è¡Œåˆ†é…ã€‚äº‹ä»¶åœ¨äº‹ä»¶æ€»çº¿å’Œç›‘å¬å™¨ä¹‹é—´é€šè¿‡ `ref` å¼•ç”¨ä¼ é€’ï¼Œæ‰€ä»¥ä½ æ— éœ€æ‹…å¿ƒç»“æ„ä½“å¤åˆ¶çš„å¼€é”€ã€‚

ä½ ä¹Ÿä¸å¿…æ‹…å¿ƒç»“æ„ä½“è¢«è£…ç®±ã€‚æ³›å‹ç±»å‹å‚æ•°ç¡®ä¿å®ƒæ°¸è¿œä¸ä¼šè¢«è£…ç®±ã€‚

* * *

ç°åœ¨å¯ä»¥è§¦å‘è¯¥äº‹ä»¶ï¼š

```c#
eventBus.Raise(new GameStartedEvent());
```

åœ¨äº‹ä»¶ä¸­åŒ…å«æ•°æ®éå¸¸ç®€å•ï¼š

```c#
public struct GameStartedEvent : IEvent
{
    public int NumberOfPlayers;
}
```

```c#
eventBus.Raise(new GameStartedEvent { NumberOfPlayers = 1 });
```

* * *

ä»¥ä¸‹æ˜¯è®¢é˜…å’Œå–æ¶ˆè®¢é˜…äº‹ä»¶çš„æ–¹æ³•ï¼š

```c#
private void OnEnable()
{
    eventBus.SubscribeTo<GameStartedEvent>(OnGameStartedEvent);
}

private void OnDisable()
{
    eventBus.UnsubscribeFrom<GameStartedEvent>(OnGameStartedEvent);
}

private void OnGameStartedEvent(ref GameStartedEvent eventData)
{
    Debug.Log($"Game started with {eventData.NumberOfPlayers} player(s)");
}
```

### ä¼˜å…ˆçº§

åœ¨è°ƒç”¨ `SubscribeTo` æ—¶ï¼Œä½ è¿˜å¯ä»¥åŒ…å«ä¸€ä¸ª `float priority` å‚æ•°ã€‚ä»¥è¾ƒé«˜ä¼˜å…ˆçº§è®¢é˜…äº‹ä»¶æ„å‘³ç€ä½ ä¼šåœ¨å…¶ä»–å…·æœ‰è¾ƒä½ä¼˜å…ˆçº§çš„ç›‘å¬å™¨ä¹‹å‰æ¥æ”¶è¯¥äº‹ä»¶ã€‚è¿™éå¸¸é€‚åˆåœ¨æ— éœ€æ‹…å¿ƒæ¯ä¸ªç›‘å¬å™¨ *ä½•æ—¶* è®¢é˜…äº‹ä»¶çš„æƒ…å†µä¸‹å®šä¹‰ç›‘å¬å™¨çš„æ‰§è¡Œé¡ºåºã€‚

```c#
private void OnEnable()
{
    eventBus.SubscribeTo<GameStartedEvent>(OnGameStartedEvent);
    eventBus.SubscribeTo<GameStartedEvent>(OnGameStartedEventPriority, 10f);
}

private void OnDisable()
{
    eventBus.UnsubscribeFrom<GameStartedEvent>(OnGameStartedEvent);
    eventBus.UnsubscribeFrom<GameStartedEvent>(OnGameStartedEventPriority);
}

private void OnGameStartedEvent(ref GameStartedEvent eventData)
{
    Debug.Log($"Game started with {eventData.NumberOfPlayers} player(s)");
}

private void OnGameStartedEventPriority(ref GameStartedEvent eventData)
{
    Debug.Log("This will be invoked first, even though it was added last!");
}
```

é»˜è®¤çš„ `priority` ä¸º `0`ï¼Œå…·æœ‰ç›¸åŒä¼˜å…ˆçº§çš„ç›‘å¬å™¨ä¼šæŒ‰ç…§å®ƒä»¬æ·»åŠ çš„é¡ºåºè¢«è°ƒç”¨ã€‚

### å®šå‘äº‹ä»¶

åœ¨ä½¿ç”¨å®šå‘äº‹ä»¶æ—¶ï¼Œäº‹æƒ…ä¼šå˜å¾—æ›´åŠ æœ‰è¶£ã€‚ä½ å¯ä»¥å°†å…¶çœ‹ä½œæ˜¯æ¶ˆæ¯æ€»çº¿ï¼Œå…¶ä¸­å¯¹è±¡å¯ä»¥è§¦å‘æ—¨åœ¨ç”±ç‰¹å®šç›®æ ‡å¯¹è±¡æ¥æ”¶çš„äº‹ä»¶ã€‚

è¦ä½¿ç”¨å®šå‘äº‹ä»¶ï¼Œä½ å¿…é¡»åœ¨ `GenericEventBus` ä¸­åŒ…å«ç¬¬äºŒä¸ªæ³›å‹ç±»å‹å‚æ•°ï¼Œä»¥æŒ‡å®šå“ªç§ç±»å‹çš„å¯¹è±¡å¯ä»¥ä½œä¸ºç›®æ ‡ï¼Œä¾‹å¦‚ `GameObject`ï¼š

```c#
var eventBus = new GenericEventBus<IEvent, GameObject>();
```

ä½ å°†è·å¾—ä¸å¦ä¸€ä¸ªäº‹ä»¶æ€»çº¿ç›¸åŒçš„æ‰€æœ‰æ–¹æ³•ï¼Œå› æ­¤ä½ ä»ç„¶å¯ä»¥è§¦å‘éå®šå‘äº‹ä»¶ï¼Œä½†ç°åœ¨ä½ å¯ä»¥åœ¨è§¦å‘äº‹ä»¶æ—¶åŒ…å«ç›®æ ‡å¯¹è±¡å’Œæºå¯¹è±¡ï¼š

```c#
eventBus.Raise(new DamagedEvent { Damage = 10f }, targetGameObject, sourceGameObject);
```

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œ`DamagedEvent` çš„å®šä¹‰æ–¹å¼ä¸å…¶ä»–äº‹ä»¶ç›¸åŒï¼š

```c#
public struct DamagedEvent : IEvent
{
    public float Damage;
}
```

* * *

è¦ç›‘å¬æ­¤äº‹ä»¶ï¼Œè¯·ä½¿ç”¨ `SubscribeToTarget` æ–¹æ³•ï¼š

```c#
private float health = 100f;

private void OnEnable()
{
    eventBus.SubscribeToTarget<DamagedEvent>(gameObject, OnDamagedEvent);
}

private void OnDisable()
{
    eventBus.UnsubscribeFromTarget<DamagedEvent>(gameObject, OnDamagedEvent);
}

private void OnDamagedEvent(ref DamagedEvent eventData, GameObject target, GameObject source)
{
    health -= eventData.Damage;
    
    Debug.Log($"{target} received {eventData.Damage} damage from {source}");
}
```

* * *

è¿™ç§æ¨¡å¼å…è®¸å¯¹è±¡ä»¥éå¸¸ä½è€¦åˆçš„æ–¹å¼ç›¸äº’é€šä¿¡ã€‚å¦‚æœæ²¡æœ‰å¯¹è±¡ç›‘å¬ç›®æ ‡å¯¹è±¡ï¼Œäº‹ä»¶å°†è¢«å¿½ç•¥ã€‚

è¿™ç§æ¨¡å¼çš„å¦ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œç°åœ¨ä½ æ‹¥æœ‰ä¸€ä¸ªå¯¹è±¡å—æŸæ—¶çš„äº‹ä»¶ï¼Œä»»ä½•è„šæœ¬éƒ½å¯ä»¥ç›‘å¬è¯¥äº‹ä»¶ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœä½ æƒ³åœ¨ç©å®¶é€ æˆä¼¤å®³çš„ä»»ä½•å¯¹è±¡ä¸Šæ˜¾ç¤ºä¼¤å®³æ•°å€¼çš„ UIï¼Œå¯ä»¥è¿™æ ·å®ç°ï¼š

```c#
private void OnEnable()
{
    eventBus.SubscribeToSource<DamagedEvent>(playerObject, OnPlayerInflictedDamageEvent);
}

private void OnDisable()
{
    eventBus.UnsubscribeFromSource<DamagedEvent>(playerObject, OnPlayerInflictedDamageEvent);
}

private void OnPlayerInflictedDamageEvent(ref DamagedEvent eventData, GameObject target, GameObject source)
{
    SpawnDamageNumberOn(target, eventData.Damage);
}
```

* * *

ä»»ä½•æ²¡æœ‰æŒ‡å®šç›®æ ‡æˆ–æ¥æºçš„ç›‘å¬å™¨éƒ½ä¼šæ¥æ”¶åˆ°æ‰€æœ‰äº‹ä»¶ï¼Œä¸è®ºç›®æ ‡æˆ–æ¥æºæ˜¯ä»€ä¹ˆã€‚éå¸¸é€‚åˆç”¨äºåƒå‡»æ€ä¿¡æ¯ï¼ˆkill feedï¼‰è¿™æ ·çš„ UIï¼š

```c#
public struct KilledEvent : IEvent
{
    public IWeapon Weapon;
}

private void OnEnable()
{
    eventBus.SubscribeTo<KilledEvent>(OnKilledEvent);
}

private void OnDisable()
{
    eventBus.UnsubscribeFrom<KilledEvent>(OnKilledEvent);
}

private void OnKilledEvent(ref KilledEvent eventData, GameObject target, GameObject source)
{
    Debug.Log($"{source} killed {target} with {eventData.Weapon}!");
}
```

* * *

### ä¿®æ”¹äº‹ä»¶æ•°æ®

ç›‘å¬å™¨å¯ä»¥ä¿®æ”¹å®ƒä»¬æ¥æ”¶åˆ°çš„äº‹ä»¶æ•°æ®ï¼Œè¿™æ ·åç»­çš„ç›‘å¬å™¨å°±ä¼šæ¥æ”¶åˆ°å·²è¢«ä¿®æ”¹çš„æ•°æ®ã€‚è¿™åœ¨å®ç°è¯¸å¦‚ä¼¤å®³ç±»å‹çš„æŠ—æ€§/å¼±ç‚¹ç­‰åŠŸèƒ½æ—¶éå¸¸æœ‰ç”¨ï¼š

```c#
public enum DamageType
{
    Bludgeoning,
    Fire,
    Cold
}

public struct DamagedEvent : IEvent
{
    public DamageType Type;
    public float Amount;
}
```

```c#
[SerializeField]
private DamageType resistanceType;

private void OnEnable()
{
    // Subscribe to the damage event targeting this game object with a higher priority than default.
    eventBus.SubscribeToTarget<DamagedEvent>(gameObject, OnDamagedEvent, 100f);
}

private void OnDisable()
{
    eventBus.UnsubscribeFromTarget<DamagedEvent>(gameObject, OnDamagedEvent);
}

private void OnDamagedEvent(ref DamagedEvent eventData)
{
    // If we are resistant to this damage type, halve the damage.
    if (eventData.Type == resistanceType)
    {
        eventData.Amount *= 0.5f;
    }
}
```

#### æ¶ˆè€—äº‹ä»¶

ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ `ConsumeCurrentEvent()` å®Œå…¨åœæ­¢äº‹ä»¶ã€‚è¿™å¯ä»¥ç”¨æ¥å®ç°ä¸€ä¸ªå®Œå…¨ä¸å…¶ä»–ç”Ÿå‘½å€¼/ä¼¤å®³è„šæœ¬è§£è€¦çš„å¿«é€Ÿæ— æ•Œæ¨¡å¼è„šæœ¬ï¼š

```c#
[SerializeField]
private bool godMode;

private void OnEnable()
{
    // Subscribe to the damage event targeting this game object with a higher priority than default.
    eventBus.SubscribeToTarget<DamagedEvent>(gameObject, OnDamagedEvent, 100f);
}

private void OnDisable()
{
    eventBus.UnsubscribeFromTarget<DamagedEvent>(gameObject, OnDamagedEvent);
}

private void OnDamagedEvent(ref DamagedEvent eventData)
{
    // If we're in god mode, consume the event.
    if (godMode)
    {
        eventBus.ConsumeCurrentEvent();
    }
}
```