# UI组件系统 - 快速开始

## 核心概念

### 1. 父子关系（单向依赖）

```
父UI (UIView)
  ├─ 持有子组件引用列表
  ├─ 通过ComponentManager管理子组件
  ├─ 订阅事件总线接收子组件事件
  └─ 可以直接调用子组件方法

子组件 (UIComponent)
  ├─ 不持有父UI引用
  ├─ 通过事件总线发送全局事件
  ├─ 不知道谁在监听事件
  └─ 不应该引用其他子组件或父组件
```

**关键：** 父组件知道子组件，子组件不知道父组件

### 2. 组件识别（ComponentId）

每个组件实例都有唯一ID：
- 格式：`ComponentTypeName_GUID`
- 示例：`ItemSlotComponent_a1b2c3d4e5f6`
- 用途：区分同类型的多个组件实例

### 3. 通讯机制

**子组件 → 事件总线：**
```csharp
// 子组件发送全局事件（不知道谁在监听）
SendEvent(new ItemClickedEvent { ItemId = 123 });
```

**父组件接收：**
```csharp
// 订阅事件
xFrameEventBus.SubscribeTo<UIComponentEventWrapper<ItemClickedEvent>>(OnItemClicked);

// 处理事件
private void OnItemClicked(ref UIComponentEventWrapper<ItemClickedEvent> evt)
{
    // evt.ComponentId - 发送组件的ID
    // evt.Event - 实际事件数据
    
    // 方式1：通过ID获取组件
    var component = ComponentManager.GetComponent<ItemSlotComponent>(evt.ComponentId);
    
    // 方式2：直接使用SourceComponent
    var component2 = evt.SourceComponent as ItemSlotComponent;
}
```

**父组件 → 子组件：**
```csharp
// 父组件直接调用子组件方法
private List<ItemSlotComponent> _slots;

void SelectSlot(int index)
{
    _slots[index].SetSelected(true);
    _slots[index].Show();
}
```

### 4. 生命周期传递

```
父UI生命周期        →  子组件响应
─────────────────────────────────
OnShow()           →  Show() (所有可见子组件)
OnHide()           →  Hide() (所有可见子组件)
OnClose()          →  Reset() (所有子组件)
OnDestroy()        →  DestroyComponent() (所有子组件)
```

---

## 快速开始

### 步骤1: 创建组件

```csharp
using xFrame.Runtime.UI;

public class MyComponent : UIComponent
{
    // 1. 初始化（只执行一次）
    protected override void OnInitialize()
    {
        base.OnInitialize();
        // 绑定事件、获取引用
    }
    
    // 2. 设置数据（可多次）
    protected override void OnSetData(object data)
    {
        base.OnSetData(data);
        // 更新显示
    }
    
    // 3. 发送全局事件
    private void OnSomethingHappened()
    {
        SendEvent(new MyComponentEvent { ... });
    }
}

// 定义组件事件
public struct MyComponentEvent : IUIComponentEvent
{
    public int SomeValue { get; set; }
}
```

### 步骤2: 在父UI中使用

```csharp
public class MyPanel : UIPanel
{
    [SerializeField] private Transform container;
    [SerializeField] private MyComponent componentPrefab;
    
    private List<MyComponent> _components = new List<MyComponent>();
    
    protected override void OnCreate()
    {
        base.OnCreate();
        
        // 创建并持有组件引用
        for (int i = 0; i < 5; i++)
        {
            var comp = Instantiate(componentPrefab, container);
            ComponentManager.RegisterComponent(comp);  // 注册到管理器
            _components.Add(comp);                     // 父组件持有引用
            comp.SetData(GetData(i));                  // 设置数据
            comp.Show();                               // 显示
        }
        
        // 订阅全局事件
        xFrameEventBus.SubscribeTo<UIComponentEventWrapper<MyComponentEvent>>(
            OnMyComponentEvent);
    }
    
    private void OnMyComponentEvent(ref UIComponentEventWrapper<MyComponentEvent> evt)
    {
        Debug.Log($"组件 {evt.ComponentId} 发送事件");
        
        // 方式1：通过ID获取组件
        var comp = ComponentManager.GetComponent<MyComponent>(evt.ComponentId);
        
        // 方式2：直接使用SourceComponent
        var comp2 = evt.SourceComponent as MyComponent;
        
        // 父组件可以直接调用子组件方法
        comp.Show();
        comp.SetData(newData);
    }
    
    // 父组件可以直接操作持有的子组件
    public void HideAllComponents()
    {
        foreach (var comp in _components)
        {
            comp.Hide();
        }
    }
    
    protected override void OnDestroy()
    {
        xFrameEventBus.UnsubscribeFrom<UIComponentEventWrapper<MyComponentEvent>>(
            OnMyComponentEvent);
        base.OnDestroy();
    }
}
```

---

## 常用API

### UIComponent（子组件）

| 方法 | 说明 |
|------|------|
| `Initialize(parentView)` | 初始化组件 |
| `SetData(data)` | 设置数据 |
| `Show()` | 显示组件 |
| `Hide()` | 隐藏组件 |
| `Refresh()` | 刷新显示 |
| `Reset()` | 重置状态 |
| `SendEventToParent<T>(event)` | 发送事件给父UI |

### UIComponentManager（组件管理器）

| 方法 | 说明 |
|------|------|
| `RegisterComponent<T>(component)` | 注册组件 |
| `AutoRegisterComponents()` | 自动注册所有子组件 |
| `GetComponent<T>(componentId)` | 通过ID获取组件 |
| `GetComponentsOfType<T>()` | 获取指定类型的所有组件 |
| `ShowAll()` | 显示所有组件 |
| `HideAll()` | 隐藏所有组件 |
| `RefreshAll()` | 刷新所有组件 |

---

## 典型场景

### 场景1: 背包系统

```csharp
// 组件：物品槽（不知道父组件）
public class ItemSlotComponent : UIComponent
{
    private void OnSlotClicked()
    {
        // 发送全局事件
        SendEvent(new ItemSlotClickedEvent
        {
            ItemId = _currentItem.Id
        });
    }
}

// 父UI：背包面板（持有子组件引用）
public class InventoryPanel : UIPanel
{
    private List<ItemSlotComponent> _slots = new List<ItemSlotComponent>();
    
    private void OnItemSlotClicked(ref UIComponentEventWrapper<ItemSlotClickedEvent> evt)
    {
        // 通过ComponentId获取槽位
        var slot = ComponentManager.GetComponent<ItemSlotComponent>(evt.ComponentId);
        
        // 父组件直接调用子组件方法
        slot.SetSelected(true);
    }
    
    // 父组件可以直接操作所有槽位
    public void ClearAllSlots()
    {
        foreach (var slot in _slots)
        {
            slot.SetData(null);
            slot.Hide();
        }
    }
}
```

### 场景2: 技能栏

```csharp
// 组件：技能按钮（不知道父组件）
public class SkillButtonComponent : UIComponent
{
    private void OnButtonClicked()
    {
        // 发送全局事件
        SendEvent(new SkillButtonClickedEvent
        {
            SkillId = _skillData.Id
        });
    }
}

// 父UI：技能栏（持有子组件引用）
public class SkillBarPanel : UIPanel
{
    private List<SkillButtonComponent> _buttons = new List<SkillButtonComponent>();
    
    private void OnSkillButtonClicked(ref UIComponentEventWrapper<SkillButtonClickedEvent> evt)
    {
        UseSkill(evt.Event.SkillId);
        
        // 父组件可以直接操作按钮
        var button = evt.SourceComponent as SkillButtonComponent;
        button.StartCooldown();
    }
    
    // 父组件可以批量操作
    public void RefreshAllButtons()
    {
        foreach (var button in _buttons)
        {
            button.Refresh();
        }
    }
}
```

### 场景3: 聊天系统

```csharp
// 组件：聊天气泡
public class ChatBubbleComponent : UIComponent
{
    protected override void OnSetData(object data)
    {
        if (data is ChatMessage msg)
        {
            DisplayMessage(msg);
        }
    }
}

// 父UI：聊天面板
public class ChatPanel : UIPanel
{
    public void AddMessage(ChatMessage msg)
    {
        var bubble = Instantiate(bubblePrefab, chatContainer);
        ComponentManager.RegisterComponent(bubble);
        bubble.SetData(msg);
        bubble.Show();
    }
}
```

---

## 注意事项

### ✅ 要做的

1. **始终调用base方法**
   ```csharp
   protected override void OnShow()
   {
       base.OnShow(); // 必须调用！
       // 你的逻辑
   }
   ```

2. **取消事件订阅**
   ```csharp
   protected override void OnDestroy()
   {
       xFrameEventBus.UnsubscribeFrom<...>(OnEvent);
       base.OnDestroy();
   }
   ```

3. **使用ComponentId识别**
   ```csharp
   // 通过ComponentId获取具体组件
   var comp = ComponentManager.GetComponent<T>(evt.ComponentId);
   ```

### ❌ 不要做的

1. **不要在子组件中持有父组件引用**
   ```csharp
   // ❌ 错误：子组件不应该知道父组件
   public class ItemSlotComponent : UIComponent
   {
       private InventoryPanel _parentPanel; // 不要这样！
       
       private void OnClick()
       {
           _parentPanel.HandleClick(); // 不要直接调用父组件
       }
   }
   
   // ✅ 正确：通过事件总线发送
   public class ItemSlotComponent : UIComponent
   {
       private void OnClick()
       {
           SendEvent(new ItemClickedEvent { ... });
       }
   }
   ```

2. **不要在子组件间建立引用**
   ```csharp
   // ❌ 错误：子组件之间不应该互相引用
   public class ComponentA : UIComponent
   {
       public ComponentB otherComponent; // 不要这样！
   }
   ```

3. **不要忘记注册组件**
   ```csharp
   // ❌ 错误
   var comp = Instantiate(prefab);
   comp.Show(); // 未注册就使用
   
   // ✅ 正确
   var comp = Instantiate(prefab);
   ComponentManager.RegisterComponent(comp);
   comp.Show();
   ```

---

## 完整示例

查看以下文件获取完整示例：
- `ItemSlotComponent.cs` - 物品槽组件
- `InventoryPanel.cs` - 背包面板
- `UIComponentUsageExample.cs` - 完整使用示例

详细文档：
- `UI组件复用设计.md` - 完整设计文档

---

## 调试技巧

### 1. 打印组件信息
```csharp
Debug.Log($"ComponentId: {ComponentId}");
Debug.Log($"ParentView: {ParentView?.GetType().Name}");
Debug.Log($"IsVisible: {IsVisible}");
```

### 2. 查看组件统计
```csharp
[ContextMenu("打印组件统计")]
private void PrintStats()
{
    Debug.Log($"总组件数: {ComponentManager.GetComponentCount()}");
    Debug.Log($"ItemSlot数: {ComponentManager.GetComponentCountOfType<ItemSlotComponent>()}");
}
```

### 3. 组件命名
```csharp
protected override void OnInitialize()
{
    base.OnInitialize();
    #if UNITY_EDITOR
    gameObject.name = $"{GetType().Name}_{ComponentId}";
    #endif
}
```

---

祝你使用愉快！如有问题请查看完整文档。
